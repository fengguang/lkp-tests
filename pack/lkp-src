#!/bin/bash

LKP_SRC=${LKP_SRC:-/lkp/$USER/src}
export ARCH=${arch:-x86_64}
LKP_USER=${LKP_USER:-$USER}

[[ $OWNER ]] || OWNER="root:lkp"
OWNER_OPT="--owner $OWNER"

download()
{
	tmp_dir=/tmp/lkp_initrd-$USER
}

build()
{
	make -C $LKP_SRC/bin/event
}

install()
{
	umask 002
	rm -fr "$tmp_dir" || return
	mkdir -p $tmp_dir/rootfs/lkp/$LKP_USER/src
	mkdir -p $tmp_dir/lkp/$LKP_USER
	ln -sfT $LKP_SRC $tmp_dir/lkp/$LKP_USER/src
}

pack()
{
	local tmp_src=$tmp_dir/lkp/$LKP_USER/src
	local archive=${CACHE_DIR:-/lkp/$USER}/lkp-${ARCH}
	local cpio_cmd="cpio --quiet -o $OWNER_OPT -H newc -F ${archive}.cpio"

	rm -f $archive.cpio

	(
		cd $tmp_dir/rootfs				&& find lkp			| $cpio_cmd
		cd $tmp_dir					&& find lkp/$LKP_USER/src/*	| $cpio_cmd --append
		{
			cd $tmp_dir/lkp/$LKP_USER/src/rootfs/addon
			[ -d etc/ssh ] &&
			chmod -R 600 etc/ssh/* # to avoid sshd Permissions too open error
			chmod g-ws root
			[ -d root/.ssh ] && {
				chmod -R go-rwxs root/.ssh
				mkdir -p etc/dropbear
				cp -al root/.ssh/authorized_keys etc/dropbear/
			}
			find *			| $cpio_cmd --append
		}
		{
			# restore permission for cleanup
			cd $tmp_dir/lkp/$LKP_USER/src/rootfs/addon
			find . -type d -exec chmod g+rwx \{\} \;
			chmod -R g+rw *
		}

		[ -d /osimage/addon-${ARCH} ] &&
		cd /osimage/addon-${ARCH}			&& find *			| $cpio_cmd --append
	)

	gzip -n -9 ${archive}.cpio
	# atomic mv to avoid race condition
	mv -f ${archive}.cpio.gz ${archive}.cgz
}
